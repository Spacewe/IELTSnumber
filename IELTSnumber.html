<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Listening Practice: Numbers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        .correct-answer { color: #28a745; font-weight: 600; }
        .incorrect-answer { color: #dc3545; font-weight: 600; }
        .feedback-message { min-height: 2em; }
        select:focus, input[type="number"]:focus, input[type="text"]:focus, button:focus {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .mixed-mode-label {
            background-color: #e0f2fe; /* sky-100 */
            color: #0c4a6e; /* sky-800 */
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 8px;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col items-center justify-center min-h-screen p-4 selection:bg-sky-200 selection:text-sky-900">

    <div class="absolute top-4 right-4">
        <button id="help-button" class="bg-slate-200 hover:bg-slate-300 text-slate-600 font-medium py-2 px-3 rounded-lg shadow-sm transition-all text-sm">
            Help
        </button>
    </div>

    <div id="app-container" class="bg-white shadow-xl rounded-lg p-6 md:p-8 w-full max-w-2xl mt-16 mb-16">

        <div id="setup-section">
            <h1 class="text-3xl font-bold text-center text-sky-700 mb-6">IELTS Listening Practice: Numbers</h1>
            <div class="space-y-6">
                <div>
                    <label for="mode-select" class="block text-sm font-medium text-slate-700 mb-1">Select Mode:</label>
                    <select id="mode-select" class="mt-1 block w-full py-2 px-3 border border-slate-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                        <option value="digits">Digits (e.g., 352, 9017)</option>
                        <option value="currency">Currency (e.g., £15.50, €20, 100 sterling)</option>
                        <option value="area">Area (e.g., 12.5 ha, 500 m²)</option>
                        <option value="liters">Liters (e.g., 3.75 L)</option>
                        <option value="phone">Phone Numbers (e.g., 07700 900123)</option>
                        <option value="time">Time (e.g., 10:30, 04:15 PM, half past 2)</option>
                        <option value="postcode">Postcodes (e.g., SW1A 1AA)</option>
                        <option value="mixed">Mixed Mode <span class="mixed-mode-label">[All Types]</span></option>
                    </select>
                </div>

                <div id="digits-options" class="space-y-2">
                     <label for="digit-count" class="block text-sm font-medium text-slate-700 mb-1">Number of Digits:</label>
                     <select id="digit-count" class="mt-1 block w-full py-2 px-3 border border-slate-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                        <option value="3">3 digits</option>
                        <option value="4">4 digits</option>
                        <option value="5">5 digits</option>
                        <option value="6">6 digits</option>
                        <option value="7">7 digits</option>
                     </select>
                </div>

                <div>
                    <label for="num-questions" class="block text-sm font-medium text-slate-700 mb-1">Number of Questions:</label>
                    <input type="number" id="num-questions" value="5" min="1" max="20" class="mt-1 block w-full py-2 px-3 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                </div>
                
                <button id="start-button" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-all duration-150 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50 flex items-center justify-center">
                    Start Training
                    <svg id="start-spinner" class="spinner ml-2 hidden" viewBox="0 0 24 24"></svg>
                </button>
                 <p id="voice-error" class="text-red-500 text-sm text-center hidden">Could not initialize speech synthesis. Please try a different browser or check your settings.</p>
            </div>
        </div>

        <div id="training-section" class="hidden">
            <h2 id="question-counter" class="text-xl font-semibold text-center text-sky-600 mb-4">Question 1 of 10</h2>
            
            <div class="mb-4">
                <label for="speed-select-training" class="block text-xs font-medium text-slate-600 mb-1 text-center">Playback Speed:</label>
                <select id="speed-select-training" class="block w-1/2 mx-auto py-1 px-2 border border-slate-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-xs">
                    <option value="0.5">0.5x</option>
                    <option value="0.8">0.8x</option>
                    <option value="1" selected>1x (Normal)</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                </select>
            </div>

            <div id="prompt-area" class="text-center text-slate-600 font-medium text-lg mb-2"></div>
            <div class="flex items-center space-x-2 mb-3">
                <span id="unit-prefix" class="text-2xl font-semibold text-slate-700"></span>
                <input type="text" id="answer-input" placeholder="Type your answer here" class="flex-grow py-3 px-4 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 sm:text-lg">
                <span id="unit-suffix" class="text-2xl font-semibold text-slate-700"></span>
            </div>
             <button id="replay-audio-button" class="mb-3 w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium py-2 px-4 rounded-lg shadow-sm transition-all focus:outline-none focus:ring-2 focus:ring-slate-400 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                Replay Audio
            </button>
            <div id="feedback-area" class="feedback-message text-center text-lg font-medium mt-2 mb-4"></div>
        </div>

        <div id="results-section" class="hidden">
            <h2 class="text-2xl font-bold text-center text-sky-700 mb-6">Training Results</h2>
            <div id="score-summary" class="text-xl font-semibold text-center mb-4"></div>
            <div id="results-details" class="space-y-3 mb-6 max-h-80 overflow-y-auto p-2 bg-slate-50 rounded-md">
            </div>
            <div id="error-analysis" class="mb-6 p-3 bg-sky-50 rounded-md">
                <h3 class="text-lg font-semibold text-sky-600 mb-2">Error Analysis:</h3>
                <p id="analysis-text" class="text-sm text-slate-700"></p>
            </div>
            <button id="try-again-button" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-all duration-150 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50">
                Practice Again
            </button>
        </div>
    </div>

    <footer class="text-center text-sm text-slate-600 py-8 w-full max-w-2xl mx-auto">
        <div class="flex justify-center items-center space-x-4 mb-2">
            <a href="https://github.com" target="_blank" rel="noopener noreferrer" aria-label="GitHub" class="text-slate-500 hover:text-sky-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
            <img src="https://profile-counter.glitch.me/cosing_IELTSlistennumber/count.svg" alt="访问量计数" id="visit-counter-img" class="h-5 opacity-70">
        </div>
        <p>&copy; <span id="copyright-year">2024</span> IELTS Listening Practice. All Rights Reserved.</p>
    </footer>

    <div id="help-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-sky-700">帮助文档 (Help Document)</h3>
                <button id="close-help-modal" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
            </div>
            <div class="space-y-4 text-sm">
                <section>
                    <h4 class="font-semibold text-slate-800 mb-1">如何使用 (How to Use):</h4>
                    <p class="text-slate-600">
                        <strong>中文说明：</strong><br>
                        1. <strong>选择模式：</strong> 从下拉菜单中选择您想练习的数字类型（如纯数字、货币、面积、升、电话号码、时间、邮编或混合模式）。<br>
                        2. <strong>设置题目：</strong> 如果选择了“数字”模式，请选择数字的位数。然后设置本次练习的题目数量。<br>
                        3. <strong>开始训练：</strong> 点击“开始训练”按钮。题目会逐一通过语音播报。<br>
                        4. <strong>调整语速：</strong> 在训练界面，您可以随时通过“Playback Speed”下拉菜单调整音频播放速度。<br>
                        5. <strong>输入答案：</strong> 在输入框中键入您听到的数字或字符。对于带有单位的题目，只需输入数字部分。<br>
                        6. <strong>提交答案：</strong> 按下回车键提交。系统会判断对错并给出反馈。您可以点击“重播音频”按钮再次收听当前题目。<br>
                        7. <strong>查看结果：</strong> 完成所有题目后，会显示结果汇总页面，包括您的得分、每题详情以及简单的错误分析。<br>
                        8. <strong>再次练习：</strong> 点击“再次练习”可以返回设置页面开始新的训练。
                    </p>
                </section>
                <hr class="my-3">
                <section>
                    <p class="text-slate-600">
                        <strong>English Instructions:</strong><br>
                        1. <strong>Select Mode:</strong> Choose the type of numbers you want to practice from the dropdown menu (e.g., Digits, Currency, Area, Liters, Phone Numbers, Time, Postcodes, or Mixed Mode).<br>
                        2. <strong>Set Questions:</strong> If "Digits" mode is selected, choose the number of digits. Then, set the total number of questions for this session.<br>
                        3. <strong>Start Training:</strong> Click the "Start Training" button. Questions will be read out one by one.<br>
                        4. <strong>Adjust Speed:</strong> During training, you can adjust the audio playback speed at any time using the "Playback Speed" dropdown menu in the training interface.<br>
                        5. <strong>Enter Answer:</strong> Type the numbers or characters you hear into the input box. For questions with units, only enter the numerical value.<br>
                        6. <strong>Submit Answer:</strong> Press Enter to submit. The system will provide feedback on whether your answer is correct or incorrect. You can click the "Replay Audio" button to listen to the current question again.<br>
                        7. <strong>View Results:</strong> After completing all questions, a results page will be displayed, showing your score, details for each question, and a simple error analysis.<br>
                        8. <strong>Practice Again:</strong> Click "Practice Again" to return to the setup page and start a new training session.
                    </p>
                </section>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const setupSection = document.getElementById('setup-section');
        const trainingSection = document.getElementById('training-section');
        const resultsSection = document.getElementById('results-section');

        const modeSelect = document.getElementById('mode-select');
        const digitsOptions = document.getElementById('digits-options');
        const digitCountSelect = document.getElementById('digit-count');
        const numQuestionsInput = document.getElementById('num-questions');
        const speedSelectTraining = document.getElementById('speed-select-training'); 
        const startButton = document.getElementById('start-button');
        const startSpinner = document.getElementById('start-spinner');
        const voiceError = document.getElementById('voice-error');

        const questionCounter = document.getElementById('question-counter');
        const promptArea = document.getElementById('prompt-area');
        const unitPrefix = document.getElementById('unit-prefix');
        const answerInput = document.getElementById('answer-input');
        const unitSuffix = document.getElementById('unit-suffix');
        const feedbackArea = document.getElementById('feedback-area');
        const replayAudioButton = document.getElementById('replay-audio-button');

        const scoreSummary = document.getElementById('score-summary');
        const resultsDetails = document.getElementById('results-details');
        const errorAnalysis = document.getElementById('error-analysis');
        const analysisText = document.getElementById('analysis-text');
        const tryAgainButton = document.getElementById('try-again-button');

        const copyrightYearElement = document.getElementById('copyright-year'); 

        const helpButton = document.getElementById('help-button'); 
        const helpModalOverlay = document.getElementById('help-modal-overlay'); 
        const closeHelpModalButton = document.getElementById('close-help-modal'); 


        // Speech Synthesis
        let synth = window.speechSynthesis;
        let voices = [];
        let currentUtterance = null; 
        let defaultVoice = null; 

        // App State
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];

        function populateVoiceList() {
            voices = synth.getVoices().filter(voice => voice.lang.startsWith('en'));
            const ukFemaleVoice = voices.find(voice => voice.lang === 'en-GB' && voice.name.toLowerCase().includes('female'));
            const ukVoice = voices.find(voice => voice.lang === 'en-GB');
            
            if (ukFemaleVoice) defaultVoice = ukFemaleVoice;
            else if (ukVoice) defaultVoice = ukVoice;
            else if (voices.length > 0) defaultVoice = voices[0];
            else defaultVoice = null;

            if (!defaultVoice && synth.getVoices().length > 0) { 
                 defaultVoice = synth.getVoices()[0];
            }
            
            if (!defaultVoice) {
                console.warn("No suitable speech synthesis voice found.");
                voiceError.textContent = "Could not initialize speech synthesis. Please try a different browser or check your OS settings.";
                voiceError.classList.remove('hidden');
                startButton.disabled = true;
                startButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                 voiceError.classList.add('hidden');
                 startButton.disabled = false;
                 startButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = populateVoiceList;
        }
        populateVoiceList(); 


        // Event Listeners
        modeSelect.addEventListener('change', () => {
            const isDigitsMode = modeSelect.value === 'digits';
            digitsOptions.classList.toggle('hidden', !isDigitsMode);
        });
        modeSelect.dispatchEvent(new Event('change')); // Initialize visibility


        startButton.addEventListener('click', startTraining);
        answerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });
        replayAudioButton.addEventListener('click', replayAudio);
        tryAgainButton.addEventListener('click', () => {
            resultsSection.classList.add('hidden');
            setupSection.classList.remove('hidden');
            answerInput.value = '';
            feedbackArea.textContent = '';
             // Reset digits options visibility based on current mode select value
            modeSelect.dispatchEvent(new Event('change'));
        });

        helpButton.addEventListener('click', () => helpModalOverlay.classList.remove('hidden'));
        closeHelpModalButton.addEventListener('click', () => helpModalOverlay.classList.add('hidden'));
        helpModalOverlay.addEventListener('click', (e) => { 
            if (e.target === helpModalOverlay) {
                helpModalOverlay.classList.add('hidden');
            }
        });


        // --- Core Logic ---

        function speakText(text, callback) {
            if (!synth || !defaultVoice) {
                feedbackArea.textContent = "Speech synthesis not available.";
                feedbackArea.className = 'feedback-message text-red-500';
                if (callback) callback(); 
                return;
            }
            
            synth.cancel(); 
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.voice = defaultVoice;
            currentUtterance.lang = defaultVoice.lang; 
            currentUtterance.pitch = 1;
            currentUtterance.rate = parseFloat(speedSelectTraining.value) || 1;

            currentUtterance.onend = () => {
                answerInput.focus();
                if (callback) callback();
            };
            currentUtterance.onerror = (event) => {
                console.error('SpeechSynthesisUtterance.onerror', event);
                feedbackArea.textContent = `Speech error: ${event.error}`;
                feedbackArea.className = 'feedback-message text-red-500';
                answerInput.focus();
                 if (callback) callback();
            };
            
            synth.speak(currentUtterance);
        }

        function replayAudio() {
            if (currentUtterance) {
                const textToReplay = currentUtterance.text;
                speakText(textToReplay);
            }
        }
        
        function getSpokenTime(h, m) {
            let hourFor12 = h % 12;
            if (hourFor12 === 0) hourFor12 = 12; 

            const ampm = h < 12 || h === 24 ? 'AM' : 'PM'; 
            if (h === 0 && m === 0) return "midnight";
            if (h === 12 && m === 0) return "midday";

            const style = Math.random();

            if (style < 0.25) { // e.g., "ten thirty AM"
                let hourPart = hourFor12.toString();
                let minutePart = m.toString().padStart(2, '0');
                if (m === 0) minutePart = "o'clock";
                else if (m < 10) minutePart = `oh ${m}`; // "oh five"
                else minutePart = m.toString(); // "thirty"
                
                let spoken = `${hourPart} ${minutePart}`;
                if (minutePart !== "o'clock") spoken += ` ${ampm}`;
                else if (h !==0 && h !== 12) spoken += ` ${ampm}`; // 1 AM o'clock, but not midnight/midday o'clock
                return spoken;
            } else if (style < 0.5) { // e.g. "five fifteen PM" (digits for minutes)
                 let hourPart = hourFor12.toString();
                 let minutePartSpoken = m.toString().padStart(2,'0').split('').join(' '); // "one five" for 15
                 if (m === 0) minutePartSpoken = "o'clock";

                 let spoken = `${hourPart} ${minutePartSpoken}`;
                 if (minutePartSpoken !== "o'clock") spoken += ` ${ampm}`;
                 else if (h !==0 && h !== 12) spoken += ` ${ampm}`;
                 return spoken;
            } else if (style < 0.75 || m === 0 || m === 15 || m === 30 || m === 45) { // O'clock, half past, quarter
                if (m === 0) return `${hourFor12} o'clock` + (h !==0 && h !== 12 ? ` ${ampm}` : "");
                if (m === 15) return `quarter past ${hourFor12}` + ` ${ampm}`;
                if (m === 30) return `half past ${hourFor12}` + ` ${ampm}`;
                if (m === 45) return `quarter to ${ (h + 1) % 12 || 12}` + ` ${ampm === 'AM' && h === 11 ? 'PM' : ampm === 'PM' && h === 23 ? 'AM' : ampm}`; 
            } 
            // Default: Minutes past/to
            if (m < 30) return `${m} minutes past ${hourFor12}` + ` ${ampm}`;
            return `${60 - m} minutes to ${(h + 1) % 12 || 12}` + ` ${ampm === 'AM' && h === 11 ? 'PM' : ampm === 'PM' && h === 23 ? 'AM' : ampm}`;
        }

        function getRandomLetter() {
            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            return alphabet[Math.floor(Math.random() * alphabet.length)];
        }

        function generateQuestions() {
            questions = [];
            userAnswers = [];
            const numTotalQuestions = parseInt(numQuestionsInput.value);
            const overallMode = modeSelect.value;
            
            const availableModesForMixed = ['digits', 'currency', 'area', 'liters', 'phone', 'time', 'postcode'];

            for (let i = 0; i < numTotalQuestions; i++) {
                let currentMode = overallMode;
                if (overallMode === 'mixed') {
                    currentMode = availableModesForMixed[Math.floor(Math.random() * availableModesForMixed.length)];
                }

                let question = { type: currentMode, textToSpeak: '', correctAnswer: '', unitPrefix: '', unitSuffix: '', prompt: '' };
                let selectedDigitCount = parseInt(digitCountSelect.value); 
                
                if (currentMode === 'digits' && overallMode === 'mixed') { 
                    selectedDigitCount = Math.floor(Math.random() * (7 - 3 + 1)) + 3; 
                }

                switch (currentMode) {
                    case 'digits':
                        const len = selectedDigitCount;
                        let numStr = '';
                        for (let j = 0; j < len; j++) {
                            numStr += Math.floor(Math.random() * 10);
                        }
                        question.textToSpeak = numStr.split('').map(digit => digit === '0' ? (Math.random() < 0.5 ? 'oh' : 'zero') : digit).join(' '); 
                        question.correctAnswer = numStr;
                        question.prompt = `Enter the ${len}-digit number:`;
                        break;
                    case 'currency':
                        const currencyTypeRand = Math.random();
                        const amount = (Math.random() * (currencyTypeRand < 0.5 ? 5000 : 200) + 1).toFixed(Math.random() > 0.3 ? 2 : 0); // Euros tend to be smaller amounts in examples
                        question.correctAnswer = amount;

                        if (currencyTypeRand < 0.45) { // Pounds
                            question.unitPrefix = '£';
                            question.prompt = 'Enter the amount in Pounds:';
                            if (amount.includes('.')) {
                                const parts = amount.split('.');
                                question.textToSpeak = `${parts[0]} pounds and ${parts[1]} pence`;
                            } else {
                                question.textToSpeak = `${amount} pounds`;
                            }
                        } else if (currencyTypeRand < 0.9) { // Euros
                            question.unitPrefix = '€';
                            question.prompt = 'Enter the amount in Euros:';
                             if (amount.includes('.')) {
                                const parts = amount.split('.');
                                question.textToSpeak = `${parts[0]} euros and ${parts[1]} cents`;
                            } else {
                                question.textToSpeak = `${amount} euros`;
                            }
                        } else { // Sterling (spoken as pounds, no symbol, distinct prompt)
                            question.unitPrefix = ''; 
                            question.prompt = 'Enter the amount in sterling:';
                             if (amount.includes('.')) {
                                const parts = amount.split('.');
                                question.textToSpeak = `${parts[0]} sterling and ${parts[1]} pence`; // or just "X sterling Y"
                            } else {
                                question.textToSpeak = `${amount} sterling`;
                            }
                        }
                        break;
                    case 'area':
                        const areaTypeRand = Math.random();
                        if (areaTypeRand < 0.5) { // Hectares
                            const hectares = (Math.random() * 100 + 0.5).toFixed(1);
                            question.textToSpeak = `${hectares} hectares`;
                            question.correctAnswer = hectares;
                            question.unitSuffix = 'ha';
                            question.prompt = 'Enter the area in hectares:';
                        } else { // Square meters
                            const sqm = Math.floor(Math.random() * 5000 + 100);
                            question.textToSpeak = `${sqm} square meters`;
                            question.correctAnswer = sqm.toString();
                            question.unitSuffix = 'm²';
                            question.prompt = 'Enter the area in square meters:';
                        }
                        break;
                    case 'liters':
                        const liters = (Math.random() * 20 + 0.25).toFixed(2);
                        question.textToSpeak = `${liters} liters`;
                        question.correctAnswer = liters;
                        question.unitSuffix = 'L';
                        question.prompt = 'Enter the volume in liters:';
                        break;
                    case 'phone':
                        let phone = '07'; 
                        for (let j = 0; j < 9; j++) {
                            phone += Math.floor(Math.random() * 10);
                        }
                        let spokenPhone = "";
                        for (let k=0; k < phone.length; k++) {
                            if (k+2 < phone.length && phone[k] === phone[k+1] && phone[k] === phone[k+2]) {
                                spokenPhone += `triple ${phone[k] === '0' ? (Math.random() < 0.5 ? 'oh' : 'zero') : phone[k]} `;
                                k += 2;
                            } else if (k+1 < phone.length && phone[k] === phone[k+1]) {
                                spokenPhone += `double ${phone[k] === '0' ? (Math.random() < 0.5 ? 'oh' : 'zero') : phone[k]} `;
                                k += 1;
                            } else {
                                spokenPhone += `${phone[k] === '0' ? (Math.random() < 0.5 ? 'oh' : 'zero') : phone[k]} `;
                            }
                        }
                        question.textToSpeak = spokenPhone.trim();
                        question.correctAnswer = phone;
                        question.prompt = 'Enter the phone number:';
                        break;
                    case 'time':
                        const h = Math.floor(Math.random() * 24);
                        const m = Math.floor(Math.random() * 60);
                        question.correctAnswer = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                        question.textToSpeak = `The time is ${getSpokenTime(h,m)}.`;
                        question.prompt = 'Enter the time (HH:MM):';
                        break;
                    case 'postcode':
                        const pc = `${getRandomLetter()}${getRandomLetter()}${Math.floor(Math.random()*10)}${Math.floor(Math.random()*10)}${getRandomLetter()}${getRandomLetter()}`;
                        question.correctAnswer = pc;
                        question.textToSpeak = pc.split('').join(' ');
                        question.prompt = 'Enter the postcode:';
                        break;
                }
                questions.push(question);
            }
        }
        
        async function startTraining() {
            if (!defaultVoice && synth.getVoices().length > 0) { 
                populateVoiceList();
            }
            if (!defaultVoice) {
                 voiceError.textContent = "Cannot start training: No speech synthesis voice available.";
                 voiceError.classList.remove('hidden');
                 console.error("Cannot start training: No speech synthesis voice available.");
                 return;
            }
            voiceError.classList.add('hidden');

            startSpinner.classList.remove('hidden');
            startButton.disabled = true;

            await new Promise(resolve => setTimeout(resolve, 200));

            generateQuestions();
            if (questions.length === 0) {
                voiceError.textContent = "Could not generate questions. Please check settings.";
                voiceError.classList.remove('hidden');
                startSpinner.classList.add('hidden');
                startButton.disabled = false;
                return;
            }
            currentQuestionIndex = 0;
            userAnswers = [];

            setupSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            trainingSection.classList.remove('hidden');
            
            // Initial visibility of digitsOptions based on the first question if in mixed mode
            if (modeSelect.value === 'mixed' && questions.length > 0) {
                 digitsOptions.classList.toggle('hidden', questions[0].type !== 'digits');
            } else {
                 digitsOptions.classList.toggle('hidden', modeSelect.value !== 'digits');
            }


            startSpinner.classList.add('hidden');
            startButton.disabled = false;
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex < questions.length) {
                const q = questions[currentQuestionIndex];
                questionCounter.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
                promptArea.textContent = q.prompt;
                unitPrefix.textContent = q.unitPrefix || '';
                unitSuffix.textContent = q.unitSuffix || '';
                answerInput.value = '';
                feedbackArea.textContent = '';
                feedbackArea.className = 'feedback-message text-center text-lg font-medium mt-2 mb-4'; 
                
                // For mixed mode, ensure digit options visibility matches current question type
                if (modeSelect.value === 'mixed') {
                    digitsOptions.classList.toggle('hidden', q.type !== 'digits');
                }
                // For non-mixed mode, it's handled by modeSelect change listener and startTraining.

                speakText(q.textToSpeak);

            } else {
                showResults();
            }
        }

        function normalizeAnswer(answer, type) {
            let normalized = answer.trim();
            if (type === 'postcode'){
                return normalized.toUpperCase().replace(/\s/g, '');
            }
            normalized = normalized.toLowerCase();
            if (type === 'digits' || type === 'phone') {
                return normalized.replace(/\s/g, ''); 
            }
            if (type === 'currency' || type === 'area' || type === 'liters') {
                normalized = normalized.replace(/£|€|m²|ha|l|,/g, ''); 
                return normalized.replace(/\s/g, '');
            }
            if (type === 'time') {
                normalized = normalized.replace(/\s/g, '');
                if (/^\d{1,2}:\d{2}$/.test(normalized)) {
                    const parts = normalized.split(':');
                    const h = parts[0].padStart(2, '0');
                    const m = parts[1].padStart(2,'0'); 
                    return `${h}:${m}`;
                }
                return normalized; 
            }
            return normalized;
        }


        function checkAnswer() {
            const userAnswerRaw = answerInput.value;
            const currentQuestion = questions[currentQuestionIndex];
            const userAnswerNormalized = normalizeAnswer(userAnswerRaw, currentQuestion.type);
            const correctAnswerNormalized = normalizeAnswer(currentQuestion.correctAnswer, currentQuestion.type);

            const isCorrect = userAnswerNormalized === correctAnswerNormalized;

            userAnswers.push({
                questionText: currentQuestion.textToSpeak,
                userAnswer: userAnswerRaw,
                correctAnswer: currentQuestion.correctAnswer,
                isCorrect: isCorrect,
                type: currentQuestion.type,
                prompt: currentQuestion.prompt,
                unitPrefix: currentQuestion.unitPrefix,
                unitSuffix: currentQuestion.unitSuffix
            });

            if (isCorrect) {
                feedbackArea.textContent = 'Correct!';
                feedbackArea.className = 'feedback-message text-center text-lg font-medium mt-2 mb-4 correct-answer';
            } else {
                feedbackArea.textContent = `Incorrect. Correct answer was: ${currentQuestion.correctAnswer}`;
                feedbackArea.className = 'feedback-message text-center text-lg font-medium mt-2 mb-4 incorrect-answer';
            }
            
            setTimeout(() => {
                currentQuestionIndex++;
                displayQuestion();
            }, isCorrect ? 1500 : 3000); 
        }

        function showResults() {
            trainingSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');

            let correctCount = 0;
            resultsDetails.innerHTML = ''; 

            userAnswers.forEach((ans, index) => {
                if (ans.isCorrect) correctCount++;
                const detailDiv = document.createElement('div');
                detailDiv.className = `p-3 rounded-md ${ans.isCorrect ? 'bg-green-50' : 'bg-red-50'}`;
                
                let displayCorrectAnswer = ans.correctAnswer;
                if (ans.unitPrefix) displayCorrectAnswer = ans.unitPrefix + displayCorrectAnswer;
                if (ans.unitSuffix) displayCorrectAnswer = displayCorrectAnswer + " " + ans.unitSuffix;

                detailDiv.innerHTML = `
                    <p class="font-semibold text-sm text-slate-700">Question ${index + 1} (${ans.type})</p>
                    <p class="text-xs text-slate-500 italic">Spoken: "${ans.questionText}"</p>
                    <p class="text-sm">Your answer: <span class="font-medium">${ans.userAnswer || "(empty)"}</span></p>
                    ${!ans.isCorrect ? `<p class="text-sm">Correct answer: <span class="font-medium text-green-700">${displayCorrectAnswer}</span></p>` : ''}
                    <p class="text-sm font-semibold ${ans.isCorrect ? 'text-green-600' : 'text-red-600'}">${ans.isCorrect ? 'Correct' : 'Incorrect'}</p>
                `;
                resultsDetails.appendChild(detailDiv);
            });

            scoreSummary.textContent = `You got ${correctCount} out of ${questions.length} correct.`;

            let analysisHtml = `Overall: ${correctCount}/${questions.length} correct.<br>`;
            const errorsByType = {};
            const questionsByType = {};
            let incorrectDigitsOrChars = []; // Changed name for postcodes

            userAnswers.forEach(ans => {
                if (!questionsByType[ans.type]) {
                    questionsByType[ans.type] = { total: 0, correct: 0 };
                }
                questionsByType[ans.type].total++;
                if (ans.isCorrect) {
                    questionsByType[ans.type].correct++;
                } else {
                    if (!errorsByType[ans.type]) errorsByType[ans.type] = [];
                    errorsByType[ans.type].push(ans);
                    
                    if (['digits', 'phone', 'postcode'].includes(ans.type)) { // Added postcode
                        for(let char of ans.correctAnswer.toUpperCase()) { // Ensure correct answer is also normalized for comparison
                            if (!ans.userAnswer.toUpperCase().includes(char)) {
                                incorrectDigitsOrChars.push(char);
                            }
                        }
                    }
                }
            });
            
            analysisHtml += "<br><strong>Performance by Type:</strong><ul>";
            for (const type in questionsByType) {
                const capType = type.charAt(0).toUpperCase() + type.slice(1);
                analysisHtml += `<li>${capType}: ${questionsByType[type].correct}/${questionsByType[type].total} correct</li>`;
            }
            analysisHtml += "</ul>";

            if (incorrectDigitsOrChars.length > 0) {
                const charFrequency = incorrectDigitsOrChars.reduce((acc, char) => {
                    acc[char] = (acc[char] || 0) + 1;
                    return acc;
                }, {});
                const sortedCommonlyMissedChars = Object.entries(charFrequency)
                    .sort(([,a],[,b]) => b-a)
                    .slice(0, 5) 
                    .map(([char, count]) => `${char} (missed ${count} times)`);

                if (sortedCommonlyMissedChars.length > 0) {
                    analysisHtml += `<br><strong>Potentially difficult digits/characters:</strong> ${sortedCommonlyMissedChars.join(', ')}. (Simple analysis)`;
                }
            }
            
            if (correctCount === questions.length) {
                analysisHtml = "Excellent! You got all questions correct!";
            } else if (Object.keys(errorsByType).length === 0 && correctCount < questions.length) { // Should not happen if not all correct
                 analysisHtml += "<br>Review your answers to see where you can improve.";
            }


            analysisText.innerHTML = analysisHtml;
        }

        // Initial setup
        copyrightYearElement.textContent = new Date().getFullYear();
        
        modeSelect.dispatchEvent(new Event('change')); 
        
        if (synth.getVoices().length === 0 && synth.onvoiceschanged === undefined) { 
            setTimeout(populateVoiceList, 200); 
        } else if (synth.getVoices().length > 0) {
             populateVoiceList(); 
        }
    </script>
</body>
</html>
